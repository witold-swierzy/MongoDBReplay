## MongoDB Replay

Purpose of this tool is to provide support with assessment of a MongoDB application with Oracle MongoDB API.

The repository contains source code of two artifacts
1. MDBExtractor.jar
   - this is the tool, which extracts stream of commands from a log file generated by a MongoDB instance.

2. MDBApplier.jar
   - this is the tool, which executes commands extracted during the extraction process against an Oracle MongoDB API instance

## License

Copyright (c) 2025 Oracle and/or its affiliates.

Licensed under the Universal Permissive License (UPL), Version 1.0.

See [LICENSE](https://github.com/oracle-devrel/technology-engineering/blob/main/LICENSE) for more details.

## WARNING
#### This tool has been developed for test purposes only!
#### Do not use this tool against production databases! It may drive to serious damages of a database or complete data loss! Oracle does not guarantee and does not take any responsibility of possible problems/issues/damages/data corruptions caused by using this tool.


## Usage
1. Generic requirements
   - MR_CONFIG_DIR variable has to be set to a directory, where configuration and log files are/will be stored

1.MDBExtractor
  requirements:
  - Source MongoDB instance up and running
  - Profiling enabled at the MongoDB instance level set by execution the following command
     db.setProfilingLevel(0, -1)
  - The following configuration file $MR_CONFIG_DIR/MDBExtractConfig.json needs to be existing with the following parameters

    OUTPUT_DIR             : optional; points to directory where output files will be created;
    		             if this parameter is not set, then MDBExtractor will print out results into standard output

    INPUT_FILE             : optional; points to an input log file generated by a MongoDB Instance with profiling enabled
                             if this parameter is not set, then MDBExtractor will read data from standard input

    COMMANDS_LOGGING       : optional; default value "true", if set to "true" then every command found by the extractor will be 
                             additional logged with console.log(...). Useful, when output will be processed by mongosh tool, which
                             has limited capabilities related to error reporting. When set to "false" only commands will be reported.

    INCLUDE_COMMANDS       : optional; JSON array allowing for providing list of commands, which will be extracted;
                             all commands not listed here will not be printed out into output; this parameter CANNOT be used
                             simultanously with EXCLUDE_COMMANDS

    EXCLUDE_COMMANDS       : optional; JSON array allowing for providing list of commands, which will be ignored during extraction process;
                             all commands listed here will not be printed out into output; this parameter CANNOT be used
                             simultanously with INCLUDE_COMMANDS
    if none of above parameters is set, then all commands will be traced

    INCLUDE_DATABASES      : optional; JSON array allowing for providing list of databases, which will be traced.
                             all databases not listed here will not be traced. 
                             This parameter cannot be used simultaneously with EXCLUDE_DATABASES

    EXCLUDE_DATABASES      : optional; JSON array allowing for providing list of databases, which will not be traced.
                             all databases not listed here will be traced. 
                             This parameter cannot be used simultaneously with INCLUDE_DATABASES
    if none of above parameters is set, then all databases will be traced

    EXECUTION_PLAN_TRACING : if set to a non-zero value, then output will contain explain() commands instead of runCommand;
                             useful, when there is need to check/compare execution plans between a source and a target system

    OUTPUT_MODE            : can be set to JSON, which result in that the output data will be formated into sequence of JSON documents
                             or to SCRIPT, wich will result in that the output data will be formated into NodeJS script, which can be 
                             consumed by mongosh
    LOG_FILE               : name of log file used by the tool; optional; if not set then all diangostic messages will be redirected to
                             standard diagnostic output

    LOG_LEVEL              : optional; can be set to 0,1 or 2. Default value : 0
                             0 means that only summary of initialization and processing will be logged
                             1 means that additionally to summaries also errors will be logged
                             2 means that additionally to summaries and errors all commands will be logged

    Configuration File example:
	```
	{
        	"OUTPUT_DIR"             : "/opt/mongo_tests/output",
        	"INPUT_FILE"             : "/opt/mongo_tests/mongod01.log",
         	"COMMANDS_LOGGING"       : "false",
        	"INCLUDE_DATABASES"      : ["oradev","test"],
        	"EXCLUDE_COMMANDS"       : ["insert"],
        	"EXECUTION_PLAN_TRACING" : 0,
        	"OUTPUT_MODE"            : "JSON"
	} 
   examples of using the tool
   1. ```
      java -jar ./MDBExtract.jar	    
      ```	
      this example reads data from a file pointed by INPUT_FILE parameter and generates output into set of files created in 
      OUTPUT_DIR (every traced database will use a separate output file)

   2. ```
      tail -n 10000 -f ./mongod.log|java -jar ./MDBExtract.jar
      ```
      this example assumes, that INPUT_FILE parameter IS NOT SET. Instead of the tool reads data from its standard input

2.MDBApplier
  requirements
  - target MongoDB instance up and running
  - the following configuration file $MR_CONFIG_DIR/MDBApplierConfig.json needs to be existing with the following parameters
    INPUT_FILE     : optional; points to an input log file generated by MDBExtractor
                     if this parameter is not set, then MDBApplier will read data from standard input
    DB_NAME        : optional; allows for providing target database name 
    CONNECT_STRING : mandatoryl; connect string to a target MongoDB or Oracle API for MongoDB instance 
    LOG_FILE       : name of log file used by the tool; optional; if not set then all diangostic messages will be redirected to
                     standard diagnostic output

    LOG_LEVEL              : optional; can be set to 0,1 or 2. Default value : 0
                             0 means that only summary of initialization and processing will be logged
                             1 means that additionally to summaries also errors will be logged
                             2 means that additionally to summaries and errors all commands will be logged
    	
   Configuration file example:
   ```
   {
         "INPUT_FILE"            : "/opt/mongo_tests/output/oradev.json",
         "DB_NAME"               : "test",
         "LOG_FILE"             : "/opt/mongo_tests/MDBApply.log",
         "CONNECT_STRING"        : "mongodb://mongo-oci.acompany.com/test"
   }
   ```
examples of using applier:
1. ```
   java -jar ./MDBApplier.jar
   ```
   this example reads data from a file pointed by INPUT_FILE parameter and executes found commands against the database pointed by 
   CONNECT_STRING and DB_NAME


    
