## MongoDB Replay

This repository contains a tool, which can be used to analyze log files generated by a MongoDB instance and generate JavsScripts scripts containing all commands found in these log files.
Such scripts can be easily used as a Mongo Shell scripts to reexecute (replay) the workload against another MongoDB instance or Oracle MongoDB API system.

## Internal Only
This tool has been developed for internal purposes only. It should not be shared, at the current stage of development with customers.

## License

Copyright (c) 2025 Oracle and/or its affiliates.

Licensed under the Universal Permissive License (UPL), Version 1.0.

See [LICENSE](https://github.com/oracle-devrel/technology-engineering/blob/main/LICENSE) for more details.

# Usage
Below we describe the scenario of using this tool

Step 1.
There is need to have a target database prepared. This database should also contain all the data structures required by the application we want to trace.
So, for example in case when we would like to use an Oracle Autonomous Database, we should 
   a. provision it first
   b. enable MongoDB API
   c. prepare the database schema(s) used by the application
It can be done in many ways, for example by using mongodump/mongorestore tools ...
MongoDBReplay is not a tool, which can be used to migrate the database. It can be used to diagnose and solve problems related to compatibility and performance.

Step 2.
There is need to enable profiling in the original(source) Mongo database.
It can be done by executing the following MongoDB command:
    db.setProfilingLevel(0, -1)

Step 3.
Now we can start an application we want to trace and connect it to the database where we enabled profiling.
We should use this application in a way it is used normally - it will execute Mongo commands, which are logged into the logfile.

Step 4.
After some time we can download the log file generated by the source MongoDB instance, which contains all the statements executed by the traced application.
By default MongoDB generates the following log file:
/var/log/mongodb/mongod.log

Step 5.
MongoDBReplay uses simple configuration file, which provides information about which data we want to analyse.
Below we present a template of this JSON file


{

        "INPUT_FILE"             : "path_to_logfile_and_its_name",
        "OUTPUT_DIR"             : "directory_where_output_scripts_will_be_generated",
        "COMMANDS_LOGGING"       : "true|false",
        "INCLUDE_COMMANDS"       : [list_of_commands to trace],
        "EXCLUDE_COMMANDS"       : [list_of_commands to do not trace],
        "INCLUDE_DATABASES"      : [list_of_mongoDB_databases_we_want_to_analyze],
        "EXCLUDE_DATABASES"      : [list_of_databases_we_don't_want_to_trace]
        "EXECUTION_PLAN_TRACING" : 0-3
}

###Note 1:
Parameters INCLUDE_* and EXCLUDE_* cannot be used at the same time.

###Note 2:
Parameter EXECUTION_PLAN_TRACING can be set to one of the following values
0 : it is default level causing, that execution plan tracing is disable; output script will contain normaln db.runCommand statements
1 : it is level causing, that the output script will contain explain commmands with tracing level set to "query planner" level
2 : it is level causing, that the output script will contain explain commmands with tracing level set to "execution stats" level
3 : it is level causing, that the output script will contain explain commmands with tracing level set to "allPlansExecution" level

To provide to MongoDBReplay information about location and name of this configuration file, we need to set the following environment variable
  export MR_CONFIG_FILE=<location_and_name_of_the_configuration_file>

Step 6.
Run the MongoReplayTool.
This tool has been developed using Oracle JDK 21, so we should use this or newer version of JDK to compile and run MongoReplay

Step 7.
MongoReplay generates set of output files in the directory pointed by OUTPUT_DIR parameter (see point 5).
Every output file contains commands executed against a single one database. Their names can be provided in DB_NAMES parameter

Step 8.
Use the files.
#1 The simplest way of using scripts generated in Step 7 is to run them in mongosh tool.
   example:
       mongosh 'mongo_connection_details' < test.js
   or (to generate an output file) 
       mongosh 'mongo_connection_details' < test.js > output.log 2&>1

#2 When INPUT_FILE parameter is not set, the tool reads data from standard input.
   In that case it is possible to use current MongoDB log file to reproduce commands in real-time scenario.
   example:
	tail -n 10000 -f /var/log/mongod.log|java -jar MongoDBReplay.jar

#3 When OUTPUT_DIR parameter is not set, the tool writes data into standard output. 
   In that case it is possible to use it in the following way
        tail -n 10000 -f /var/log/mongod.log|java -jar MongoDBReplay.jar 1>./operations.js 2>./log.txt

   Also in case when both above parameters are not set it is possible to use this tool to replicate commands between
   - two MongoDB/Oracle API for MongoDB instances:
   	tail -n 10000 -f /var/log/mongod.log|java -jar MongoDBReplay.jar|mongosh 'connection_details'
